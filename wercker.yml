---
box: node
# Build definition
build:
  # The steps that will be executed on build

  # Build hugo site
  steps:
    - script:
        name: Update and Install Packages
        code: |
          apt-get update && apt-get upgrade -y
          apt-get install build-essential wget -y -f
    
    - npm-install

    - script:
        name: Install hugo
        code: |
          wget https://github.com/spf13/hugo/releases/download/v0.16/hugo_0.16-1_amd64.deb
          dpkg -i hugo_0.16-1_amd64.deb

    - script:
        name: Build website with gulp
        code: |
          npm install --global gulp-cli
          npm install --save-dev gulp
          gulp config-prod
          gulp build
          cat rev-manifest.json  

# A step that deploys hugo build
deploy:
  steps:
    - script:
        name: Update and Install Packages
        code: |
          apt-get update && apt-get upgrade -y
          apt-get install openssh-client rsync -y -f
    - add-to-known_hosts:
        hostname: $DO_IZUMI_HOST
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DO_IZUMI_PRIVATE
        overwrite: true

    - script:
            name: upload public content to remote host
            code: |
                rsync -avz --rsync-path="sudo rsync" --rsh="ssh -o BatchMode=yes -p 22 -i $PRIVATEKEY_PATH" "public/" "$DO_IZUMI_USER@$DO_IZUMI_HOST:/var/www/addhenltd" --chown=www-data:www-data
    - script:
            name: upload mail folder
            code: |
                rsync -avz --rsync-path="sudo rsync" --rsh="ssh -o BatchMode=yes -p 22 -i $PRIVATEKEY_PATH" "mail" "$DO_IZUMI_USER@$DO_IZUMI_HOST:/var/www/addhenltd" --chown=www-data:www-data