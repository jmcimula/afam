---
box: debian
# Build definition
build:
  # The steps that will be executed on build

  # Build hugo site
  steps:
    - install-packages:
        packages: 
          build-essential
          ruby
          rubygems
          ruby-dev
          openssh-client
          rsync
    - script:
        name: Install bootstrap sass
        code: |
          gem install bootstrap-sass

    - eyedol/compass-compile:
        config-file: $WERCKER_ROOT/themes/mdb-addhen/static/config.rb
        flags: --output-style compressed

    - arjen/hugo-build:
        version: 0.15
        config: ./config.yaml
        flags: --buildDrafts=true

# A step that deploys hugo build
deploy:
  steps:
    - install-packages:
        packages: 
          openssh-client
          rsync
    - add-to-known_hosts:
        hostname: $DO_IZUMI_HOST
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DO_IZUMI_PRIVATE
        overwrite: true

    - fedor/rsync-soft-deploy:
        host: $DO_IZUMI_HOST
        directory: ~/www/addhenltd
        sshkey: $PRIVATEKEY_PATH
        user: $DO_IZUMI_USER
        source: public/

    - script:
            name: change directory permission
            code: |
                ssh -i $PRIVATEKEY_PATH -l $DO_IZUMI_USER -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $HOSTNAME chown -R www-data:www-data /var/www/addhenltd
