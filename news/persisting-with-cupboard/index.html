<!doctype html><!--[if lt IE 7]> <html class="ie6" lang="ja" prefix="og: http://ogp.me/ns#"> <![endif]--><!--[if IE 7]> <html class="i7" lang="ja" prefix="og: http://ogp.me/ns#"> <![endif]--><!--[if IE 8]> <html class="ie" lang="ja" prefix="og: http://ogp.me/ns#"> <![endif]--> <!--[if gt IE 8]><!--><!--<![endif]--><html lang="en-US" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta property="og:title" content="Persisting Data Objects With Cupboard"><meta property="og:description" content="There are serveral contenders when it comes to persisting data on Android. At addhen, our favourite is cupboard. It&rsquo;s a lightweight data storage for Android. At first, it seems like an ORM but it isn&rsquo;t, as it doesn&rsquo;t manage table relationships and all that fancy features that comes with it. It gives you a neat API to store and retrieve data objects on Android. We structure our database tables around the JSON response we get from API calls."><meta property="og:type" content="website"><meta property="og:url" content="http://0.0.0.0:6789/news/persisting-with-cupboard/"><meta property="og:updated_time" content="2016-06-27 09:50:18 &#43;0900 JST"><meta itemprop="name" content="Persisting Data Objects With Cupboard"><meta itemprop="description" content="There are serveral contenders when it comes to persisting data on Android. At addhen, our favourite is cupboard. It&rsquo;s a lightweight data storage for Android. At first, it seems like an ORM but it isn&rsquo;t, as it doesn&rsquo;t manage table relationships and all that fancy features that comes with it. It gives you a neat API to store and retrieve data objects on Android. We structure our database tables around the JSON response we get from API calls."><meta itemprop="keywords" content="accessibility,database,debugging,leakcanary,localization,memory-leaks,profiling,sharing,storing,translation,"><meta itemprop="wordCount" content="797"><meta name="news_keywords" content="cupboard,json,objects,android,design,gson"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Persisting Data Objects With Cupboard"><meta name="twitter:description" content="There are serveral contenders when it comes to persisting data on Android. At addhen, our favourite is cupboard. It&rsquo;s a lightweight data storage for Android. At first, it seems like an ORM but it isn&rsquo;t, as it doesn&rsquo;t manage table relationships and all that fancy features that comes with it. It gives you a neat API to store and retrieve data objects on Android. We structure our database tables around the JSON response we get from API calls."><meta name="twitter:site" content="@afam"><meta name="twitter:domain" content="www.afam.com"><title>AFAM &mdash; Persisting Data Objects With Cupboard</title><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all"><link rel="stylesheet" href="http://0.0.0.0:6789/css/bootstrap.min.css" media="screen"><link href="https://fonts.googleapis.com/css?family=Lato|Open+Sans|Roboto+Condensed|Roboto+Mono|Roboto+Slab|Orbitron:400,500,700,900" rel="stylesheet"><link href="http://0.0.0.0:6789/css/mdb.min.css" rel="stylesheet" media="all" type="text/css"><link href="http://0.0.0.0:6789/css/styles-8609750943.min.css" rel="stylesheet" media="all" type="text/css"><link href="" rel="alternate" type="application/rss+xml" title="AFAM"></head><body><header><nav class="navbar navbar-dark navbar-fixed-top scrolling-navbar danger-color-dark"><button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#collapseEx"><i class="fa fa-bars"></i></button><div class="container"><div class="collapse navbar-toggleable-xs" id="collapseEx"><div id="logo"><a class="waves-effect waves-light navbar-brand" href="http://0.0.0.0:6789/">AFAM</a></div><ul class="nav navbar-nav smooth-scroll"><li class="nav-item"><a class="nav-link" href="http://0.0.0.0:6789/">Home</a></li><li class="nav-item"><a class="nav-link" href="http://0.0.0.0:6789/calendar">Calendar</a></li><li class="nav-item"><a class="nav-link" href="http://0.0.0.0:6789/join/">Join</a></li><li class="nav-item page-scroll"><a class="nav-link page-scroll" href="http://0.0.0.0:6789/#contact">Contact Us</a></li></ul><ul class="nav navbar-nav nav-flex-icons"><li class="nav-item"><a class="nav-link"><i class="fa fa-facebook"></i></a></li><li class="nav-item"><a class="nav-link"><i class="fa fa-twitter"></i></a></li><li class="nav-item"><a class="nav-link"><i class="fa fa-instagram"></i></a></li></ul></div></div></nav></header><div class="container"><div class="row"><div class="wrap-content col-md-10 offset-md-1"><h2>Persisting Data Objects With Cupboard</h2><ul class="list-inline"><li class="list-inline-item"><span class="post-meta"><i class="fa fa-calendar"></i> <time datetime="2016-06-27T09:50:18&#43;09:00" itemprop="datePublished">June 27, 2016</time></span></li><li class="list-inline-item"><span class="post-meta"><i class="fa fa-user"></i> Henry Addo</span></li></ul><div class="row"><div class="p-l-1"><p>There are serveral contenders when it comes to persisting data on Android. At addhen, our favourite is <a href="https://bitbucket.org/littlerobots/cupboard/wiki/Home">cupboard</a>. It&rsquo;s a lightweight data storage for Android. At first, it seems like an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> but it isn&rsquo;t, as it doesn&rsquo;t manage table relationships and all that fancy features that comes with it. It gives you a neat API to store and retrieve data objects on Android.</p><p>We structure our database tables around the <code>JSON</code> response we get from API calls. At times we&rsquo;re tempted to create tables just to conform to the structure of the <code>JSON</code> string. Hence sometimes we wished <code>cupboard</code> could manage table relationships. But it does give you the flexibility to do all of that. It just means you will have to write a bit of code to achieve that.</p><p>In most cases when we look at the structure of our <code>JSON</code> string, we look for ways to elimenate the need to create extra tables. To achieve that, we try to store some part of the <code>JSON</code> string in it serialized format. Then deserialize it upon retrieval. Cupboard provides you with the necessary mechanism to acheive all that. We&rsquo;re going to share with you how we approach this.</p><p>So let&rsquo;s say we have this <code>JSON</code> string</p><pre class="prettyprint linenums"><code class="language-java">[
  {
    &#34;id&#34;: 1,
    &#34;name&#34;: &#34;Apples&#34;,
    &#34;price&#34;: 10,
    &#34;note&#34;: &#34;I usually buy them from the convenient store.&#34;,
    &#34;expiry_date&#34;: &#34;28-07-2017&#34;,
    &#34;category&#34;: {
      &#34;id&#34;: 9,
      &#34;url&#34;: &#34;http://www.api.data.com/categories/9&#34;
    },
    &#34;quantity&#34;: {
      &#34;initial&#34;: &#34;10&#34;,
      &#34;remaining&#34;: &#34;5&#34;,
      &#34;unit&#34;: &#34;None&#34;,
      &#34;reorder&#34;: 3
    }
  },
  {
    &#34;id&#34;: 2,
    &#34;name&#34;: &#34;Arugula&#34;,
    &#34;price&#34;: 200,
    &#34;note&#34;: &#34;I got them from the amazon jp store&#34;,
    &#34;expiry_date&#34;: &#34;16-07-2018&#34;,
    &#34;category&#34;: {
      &#34;id&#34;: 9,
      &#34;url&#34;: &#34;http://www.api.data.com/categories/9&#34;
    },
    &#34;quantity&#34;: {
      &#34;initial&#34;: &#34;6&#34;,
      &#34;remaining&#34;: &#34;2&#34;,
      &#34;unit&#34;: &#34;box&#34;,
      &#34;reorder&#34;: 3
    }
  }
]
</code></pre><p>The <a href="https://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> for this will be</p><pre class="prettyprint linenums"><code class="language-java">public class InventoryEntity extends Data {

    public String name;

    public float price;

    public String note;

    public CategoryEntity category;

    public Quantity quantity;

    public Date expiryDate;

    public InventoryEntity() {
        // Do nothing
    }

    public InventoryEntity(Long id, String name, float price, Quantity quantity,
            String note, CategoryEntity category, Date expiryDate) {
        this._id = id;
        this.name = name;
        this.price = price;
        this.quantity = quantity;
        this.note = note;
        this.category = category;
        this.expiryDate = (Date) expiryDate.clone();
    }

    public static class Quantity {

        public int initial;

        public int remaining;

        public int reorder;

        public String unit;

        public Quantity(int initial, int remaining, int reorder, String unit) {
            this.initial = initial;
            this.remaining = remaining;
            this.reorder = reorder;
            this.unit = unit;
        }
    }
}
</code></pre><p>Since <code>cupboard</code> stores objects into the database, this <code>POJO</code> should just work right? But no, it doesn&rsquo;t. It wouldn&rsquo;t know how to handle the <code>Quantity</code> property as it&rsquo;s a subclass. In a regular database relationship, you could create a table to hold the <code>Quantity</code> class but you can eliminate that, if you could just store that part as a <code>JSON</code> string. This alleviates the pain of managing table relationships.</p><p>We utilize cupboard&rsquo;s converters to achieve that. In that when saving the object, we intercept the process and keep the <code>Quantity</code> property in this case, as a regular <code>JSON</code> string. We create a custom <code>FieldConverter</code> and use it to check if cupboard is about to process the <code>Quantity</code> field, then save the <code>JSON</code> string instead of the deserialized format.</p><p>First, create a generic field converter using <code>GSON</code></p><pre class="prettyprint linenums"><code class="language-java">public class GsonFieldConverter&lt;T&gt; implements FieldConverter&lt;T&gt; {

    private final Gson mGson;

    private final Type mType;

    public GsonFieldConverter(Gson gson, Type type) {
        mGson = gson;
        mType = type;
    }

    @Override
    public T fromCursorValue(Cursor cursor, int columnIndex) {
    	  // Convert from JSON string to POJO
        return mGson.fromJson(cursor.getString(columnIndex), mType);
    }

    @Override
    public void toContentValue(T value, String key, ContentValues values) {
    	 // Convert from POJO to JSON string
        values.put(key, mGson.toJson(value));
    }

    @Override
    public EntityConverter.ColumnType getColumnType() {
        return EntityConverter.ColumnType.TEXT;
    }
}
</code></pre><p>Second, by some <a href="https://docs.oracle.com/javase/tutorial/reflect/">Reflection</a> magic, cupboard allows you to figure out which field it&rsquo;s processing, allowing you to process that field before it stores or retrieves it from the database.</p><pre class="prettyprint linenums"><code class="language-java">public class InventoryEntityConverterFactory extends ReflectiveEntityConverter&lt;InventoryEntity&gt; {

    /**
     * Default constructor
     *
     * @param cupboard The {@link Cupboard} object
     */
    public InventoryEntityConverterFactory(Cupboard cupboard) {
        super(cupboard, InventoryEntity.class);
    }

    @Override
    protected FieldConverter&lt;?&gt; getFieldConverter(Field field) {
        if (&#34;quantity&#34;.equals(field.getName())) {
        	  // Use the field converter to deserilize/serialize the quantity field
            return new GsonFieldConverter&lt;&gt;(new Gson(),
                    new TypeToken&lt;InventoryEntity.Quantity&gt;() {
                    }.getType());
        }
        return super.getFieldConverter(field);
    }
}  
</code></pre><p>Third, we have to initialize this when registering the entities with cupboard otherwise all this implementation won&rsquo;t make any sense to it.</p><pre class="prettyprint linenums"><code class="language-java">private static final Class[] ENTITIES = new Class[]{
    InventoryEntity.class, CategoryEntity.class,
};

static {
    EntityConverterFactory factory = new EntityConverterFactory() {

        @Override
        public &lt;T&gt; EntityConverter&lt;T&gt; create(Cupboard cupboard, Class&lt;T&gt; type) {
            if (type == InventoryEntity.class) {
                return (EntityConverter&lt;T&gt;) new InventoryEntityConverterFactory(cupboard);
             }
             return null;
        }
    };

    CupboardFactory.setCupboard(new CupboardBuilder()
                .registerEntityConverterFactory(factory).useAnnotations().build());
    // Register our entities
    for (Class&lt;?&gt; clazz : ENTITIES) {
        cupboard().register(clazz);
    }
}
</code></pre><p>To learn more about cupboard, check its <a href="https://bitbucket.org/littlerobots/cupboard/wiki/Home">wiki</a>. It has lots of how-tos to get you started.</p></div></div><div class="row"><div class="p-l-1"><ul class="list-inline"><li class="list-inline-item"><span class="pink-text"><i class="fa fa-clock-o"></i> <time datetime="2016-06-27T09:50:18&#43;09:00" itemprop="datePublished">June 27, 2016</time></span></li><li class="list-inline-item"><a class="btn btn-primary tweet-this" href="https://twitter.com/share" title="Tweet this"><i class="fa fa-twitter"></i> Tweet</a></li></ul></div></div><div class="row"><div class="col-sm-2"><a class="btn btn-danger waves-effect waves-light" href="http://0.0.0.0:6789/news/debugging-memory-leaks-in-an-android-app/"><i class="fa fa-fw fa-long-arrow-left"></i></a></div><div class="col-sm-2 offset-md-8"><a class="btn btn-danger waves-effect waves-light pull-right" href="http://0.0.0.0:6789/news/internationalization-and-localization-on-android/"><i class="fa fa-fw fa-long-arrow-right"></i></a></div></div><div class="row"><div class="p-l-1"><div id="disqus_thread"></div><script async type="text/javascript">var disqus_shortname = 'afam';
    
     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></div></div><footer class="page-footer rgba-black-lighter center-on-small-only"><div class="footer-copyright text-xs-center rgba-black-lighter"><div class="container"><ul class="list-inline"><li class="list-inline-item">&copy; 2016 &middot; AFAM <span class="powered-by">&middot; developed by <a href="http://www.addhen.com" rel="nofollow">addhen</a></span></li></ul></div></div></footer><script type="text/javascript" src="http://0.0.0.0:6789/js/jquery-2.2.3.min.js" defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/tether.min.js" defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/bootstrap.min.js" defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/jquery.easing-1.3.min.js" defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/mdb.min.js" defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/jqBootstrapValidation-1.3.7.min.js" defer="defer"></script><script type="text/javascript" src="https://www.google.com/recaptcha/api.js" async defer="defer"></script><script type="text/javascript" src="http://0.0.0.0:6789/js/site-8b7d768f98.min.js" defer="defer"></script><script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?autoload=true&skin=sons-of-obsidian" defer="defer"></script><script async>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-XXXXXXXX-X', 'auto');
  ga('send', 'pageview');</script></body></html>